<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>노션 독서 기록 위젯</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: transparent; 
            display: flex; justify-content: center; align-items: center; height: 100vh;
        }
        #widget { width: 340px; background-color: transparent; display: flex; flex-direction: column; align-items: center; }
        .calendar-container {
            width: 100%; background-color: #ffffff; border: 1px solid #2b2b2b;
            border-radius: 4px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 15px;
        }
        .header-bar {
            width: 100%; background-color: #2b2b2b; color: #ffffff;
            display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; font-weight: 600;
        }
        .month-nav { display: flex; align-items: center; gap: 10px; font-size: 15px; }
        .month-nav button { background: none; border: none; color: #ffffff; cursor: pointer; font-size: 16px; }
        .refresh-btn { background: none; border: none; color: #ffffff; font-size: 12px; font-weight: bold; cursor: pointer; }
        .weekdays {
            display: grid; grid-template-columns: repeat(7, 1fr);
            width: 100%; text-align: center; font-size: 12px; font-weight: bold;
            color: #2b2b2b; padding: 10px 0; border-bottom: 1px solid #2b2b2b;
        }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); width: 100%; gap: 3px; padding: 8px; }
        .day-cell {
            background-color: #ffffff; border: 1px solid #2b2b2b; aspect-ratio: 1 / 1.45;
            position: relative; display: flex; padding: 4px 5px; overflow: hidden;
        }
        .day-number {
            position: relative; z-index: 2; font-size: 11px; font-weight: bold;
            color: #ffffff; mix-blend-mode: difference; line-height: 1;
        }
        .book-cover { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        .add-btn {
            background-color: #ffffff; border: 1px solid #2b2b2b; color: #2b2b2b;
            padding: 12px 20px; border-radius: 25px; font-size: 12px; font-weight: 700;
            cursor: pointer; width: 100%; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.9); display: flex; justify-content: center; align-items: center; z-index: 10;
        }
        .hidden { display: none !important; }
        .spinner { width: 20px; height: 20px; border: 3px solid #ccc; border-top-color: #2b2b2b; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="widget">
        <div class="calendar-container">
            <div class="header-bar">
                <div class="month-nav">
                    <button onclick="changeMonth(-1)">&lt;</button>
                    <span id="month-text"></span>
                    <button onclick="changeMonth(1)">&gt;</button>
                </div>
                <button class="refresh-btn" onclick="fetchMonthData()">READY ↻</button>
            </div>
            <div class="weekdays"><div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div></div>
            <div class="days-grid" id="calendar-grid"></div>
            <div id="loading" class="hidden"><div class="spinner"></div><span>Loading...</span></div>
        </div>
        <button class="add-btn" onclick="handleAddEntry()">⚘ ⋆｡°₊ ⊹˚ READING ⋆˙⟡₊ ⊹˚</button>
    </div>

    <script>
        const CONFIG = {
            NOTION_TOKEN: "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",
            BOOK_DB_ID: "3066860b8b5e800aa8a4eff715ba9d58",
            LOG_DB_ID: "3136860b8b5e80398bbad945d767f891", // 업데이트된 독서기록 ID
            DASHBOARD_DB_ID: "3096860b8b5e80ce863ae4a06e65a9ff",
            PROXY_URL: "https://cors-anywhere.herokuapp.com/"
        };

        const headers = { "Authorization": `Bearer ${CONFIG.NOTION_TOKEN}`, "Content-Type": "application/json", "Notion-Version": "2022-06-28" };
        let currentYear, currentMonth, logDataMap = {};

        function init() {
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth();
            updateMonthHeader();
            fetchMonthData();
        }

        function updateMonthHeader() { document.getElementById('month-text').textContent = `${currentMonth + 1}월`; }

        function changeMonth(step) {
            currentMonth += step;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            else if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            updateMonthHeader(); fetchMonthData();
        }

        async function fetchMonthData() {
            showLoading(); logDataMap = {};
            const startDate = new Date(currentYear, currentMonth, 1).toISOString().split('T')[0];
            const endDate = new Date(currentYear, currentMonth + 1, 0).toISOString().split('T')[0];
            try {
                const response = await fetch(`${CONFIG.PROXY_URL}https://api.notion.com/v1/databases/${CONFIG.LOG_DB_ID}/query`, {
                    method: 'POST', headers: headers,
                    body: JSON.stringify({ "filter": { "and": [{ "property": "날짜", "date": { "on_or_after": startDate } }, { "property": "날짜", "date": { "on_or_before": endDate } }] } })
                });
                const data = await response.json();
                await Promise.all(data.results.map(async (log) => {
                    const date = log.properties["날짜"].date.start;
                    const bookRelation = log.properties["책"].relation;
                    if (bookRelation.length > 0) {
                        const bookId = bookRelation[0].id;
                        const blockRes = await fetch(`${CONFIG.PROXY_URL}https://api.notion.com/v1/blocks/${bookId}/children?page_size=10`, { method: 'GET', headers: headers });
                        const blockData = await blockRes.json();
                        const imgBlock = blockData.results.find(b => b.type === 'image');
                        if (imgBlock) logDataMap[date] = imgBlock.image.type === 'external' ? imgBlock.image.external.url : imgBlock.image.file.url;
                    }
                }));
                renderCalendar();
            } catch (e) { console.error(e); } finally { hideLoading(); }
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid'); grid.innerHTML = '';
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) { const cell = document.createElement('div'); cell.className = 'day-cell'; cell.style.borderColor = 'transparent'; grid.appendChild(cell); }
            for (let d = 1; d <= daysInMonth; d++) {
                const cell = document.createElement('div'); cell.className = 'day-cell';
                const num = document.createElement('span'); num.className = 'day-number'; num.textContent = d; cell.appendChild(num);
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                if (logDataMap[dateStr]) { const img = document.createElement('img'); img.src = logDataMap[dateStr]; img.className = 'book-cover'; cell.appendChild(img); }
                grid.appendChild(cell);
            }
        }

        async function handleAddEntry() {
            showLoading();
            try {
                const bookRes = await fetch(`${CONFIG.PROXY_URL}https://api.notion.com/v1/databases/${CONFIG.BOOK_DB_ID}/query`, { method: 'POST', headers: headers, body: JSON.stringify({ "filter": { "property": "상태", "select": { "equals": "읽는 중인 책" } } }) });
                const bookData = await bookRes.json();
                if (bookData.results.length === 0) { alert("읽는 중인 책이 없습니다."); return; }
                const bookId = bookData.results[0].id;
                const monthStart = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-01`;
                const dashRes = await fetch(`${CONFIG.PROXY_URL}https://api.notion.com/v1/databases/${CONFIG.DASHBOARD_DB_ID}/query`, { method: 'POST', headers: headers, body: JSON.stringify({ "filter": { "property": "기준 날짜", "date": { "equals": monthStart } } }) });
                const dashData = await dashRes.json();
                if (dashData.results.length === 0) { alert("대시보드 페이지를 찾을 수 없습니다."); return; }
                const dashId = dashData.results[0].id;
                const today = new Date(); const kstDate = new Date(today.getTime() + (9 * 60 * 60 * 1000)).toISOString().split('T')[0];
                await fetch(`${CONFIG.PROXY_URL}https://api.notion.com/v1/pages`, {
                    method: 'POST', headers: headers,
                    body: JSON.stringify({ "parent": { "database_id": CONFIG.LOG_DB_ID }, "properties": { "이름": { "title": [{ "text": { "content": "독서 일지" } }] }, "날짜": { "date": { "start": kstDate } }, "책": { "relation": [{ "id": bookId }] }, "월간 대시보드": { "relation": [{ "id": dashId }] } } })
                });
                await fetchMonthData();
            } catch (e) { alert("기록 실패"); } finally { hideLoading(); }
        }
        function showLoading() { document.getElementById('loading').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading').classList.add('hidden'); }
        init();
    </script>
</body>
</html>
